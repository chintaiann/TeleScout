{% extends "base.html" %}

{% block title %}Home - TeleScout{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>TeleScout Dashboard</h2>
            <div id="statusIndicator" class="badge bg-secondary fs-6">Unknown</div>
        </div>
        
        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">
                            <i class="fas fa-signal me-2"></i>
                            Monitoring Status
                        </h5>
                        <p id="statusDescription" class="card-text text-muted">
                            Click "Start Monitoring" to begin scanning channels for keywords.
                        </p>
                        
                        <div id="monitoringStats" class="row mt-3" style="display: none;">
                            <div class="col-sm-6 col-lg-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-primary" id="channelsCount">0</div>
                                    <small class="text-muted">Channels</small>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-success" id="keywordsCount">0</div>
                                    <small class="text-muted">Keywords</small>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-info" id="messagesCount">0</div>
                                    <small class="text-muted">Messages Found</small>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-warning" id="uptime">00:00:00</div>
                                    <small class="text-muted">Uptime</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-md-end">
                        <div class="d-grid gap-2">
                            <button id="scanBtn" class="btn btn-info btn-lg" onclick="scanOnly()">
                                <i class="fas fa-search me-2"></i>Scan Only
                            </button>
                            <button id="realtimeBtn" class="btn btn-success btn-lg" onclick="startRealTimeMonitoring()">
                                <i class="fas fa-play me-2"></i>Real-Time Monitoring
                            </button>
                            <button id="stopBtn" class="btn btn-danger btn-lg" onclick="stopMonitoring()" style="display: none;">
                                <i class="fas fa-stop me-2"></i>Stop Monitoring
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Summary -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Configuration Summary</h6>
                        <a href="{{ url_for('config') }}" class="btn btn-sm btn-outline-primary">Edit</a>
                    </div>
                    <div class="card-body">
                        <div id="configSummary">
                            <div class="mb-2">
                                <strong>Forward to:</strong> 
                                <span id="forwardUserId" class="text-muted">Not configured</span>
                            </div>
                            <div class="mb-2">
                                <strong>Time window:</strong> 
                                <span id="timeWindow" class="text-muted">Real-time only</span>
                            </div>
                            <div class="mb-2">
                                <strong>Forward delay:</strong> 
                                <span id="forwardDelay" class="text-muted">5 seconds</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Recent Activity</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <p class="text-muted">No recent activity</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6 col-lg-3 mb-2">
                                <a href="{{ url_for('keywords') }}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-tags me-2"></i>Manage Keywords
                                </a>
                            </div>
                            <div class="col-sm-6 col-lg-3 mb-2">
                                <a href="{{ url_for('channels') }}" class="btn btn-outline-info w-100">
                                    <i class="fas fa-broadcast-tower me-2"></i>Manage Channels
                                </a>
                            </div>
                            <div class="col-sm-6 col-lg-3 mb-2">
                                <a href="{{ url_for('config') }}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </a>
                            </div>
                            <div class="col-sm-6 col-lg-3 mb-2">
                                <a href="{{ url_for('logs') }}" class="btn btn-outline-warning w-100">
                                    <i class="fas fa-file-alt me-2"></i>View Logs
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer"></div>
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script>
let monitoringStatus = 'stopped';
let startTime = null;
let uptimeInterval = null;
let statusCheckInterval = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadConfigSummary();
    checkStatus();
    
    // Check status every 5 seconds
    statusCheckInterval = setInterval(checkStatus, 5000);
});

// Clean up intervals when page is unloaded
window.addEventListener('beforeunload', function() {
    if (statusCheckInterval) clearInterval(statusCheckInterval);
    if (uptimeInterval) clearInterval(uptimeInterval);
});

async function startRealTimeMonitoring() {
    const realtimeBtn = document.getElementById('realtimeBtn');
    const stopLoadingBtn = showLoading(realtimeBtn);
    
    try {
        const response = await apiRequest('/api/monitoring/realtime', {
            method: 'POST'
        });
        
        showAlert(response.message || 'Real-time monitoring started successfully!', 'success');
        updateMonitoringStatus('running');
        
    } catch (error) {
        showAlert('Failed to start real-time monitoring: ' + error.message, 'danger');
    } finally {
        stopLoadingBtn();
    }
}

async function scanOnly() {
    const scanBtn = document.getElementById('scanBtn');
    const stopLoadingBtn = showLoading(scanBtn);
    
    try {
        const response = await apiRequest('/api/monitoring/scan', {
            method: 'POST'
        });
        
        showAlert(response.message || 'Historical scan started!', 'info');
        updateMonitoringStatus('scanning');
        
    } catch (error) {
        showAlert('Failed to start scan: ' + error.message, 'danger');
    } finally {
        stopLoadingBtn();
    }
}

async function stopMonitoring() {
    const stopBtn = document.getElementById('stopBtn');
    const stopLoadingBtn = showLoading(stopBtn);
    
    try {
        const response = await apiRequest('/api/monitoring/stop', {
            method: 'POST'
        });
        
        showAlert(response.message || 'Monitoring stopped successfully!', 'info');
        updateMonitoringStatus('stopped');
        
    } catch (error) {
        showAlert('Failed to stop monitoring: ' + error.message, 'danger');
    } finally {
        stopLoadingBtn();
    }
}

async function checkStatus() {
    try {
        const status = await apiRequest('/api/monitoring/status');
        updateMonitoringStatus(status.status, status);
    } catch (error) {
        console.error('Failed to check status:', error);
    }
}

function updateMonitoringStatus(status, data = {}) {
    monitoringStatus = status;
    
    const statusIndicator = document.getElementById('statusIndicator');
    const statusDescription = document.getElementById('statusDescription');
    const scanBtn = document.getElementById('scanBtn');
    const realtimeBtn = document.getElementById('realtimeBtn');
    const stopBtn = document.getElementById('stopBtn');
    const monitoringStats = document.getElementById('monitoringStats');
    
    if (status === 'running') {
        statusIndicator.className = 'badge bg-success fs-6';
        statusIndicator.textContent = 'Running';
        statusDescription.textContent = 'TeleScout is actively monitoring channels for keyword matches.';
        
        scanBtn.style.display = 'none';
        realtimeBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        monitoringStats.style.display = 'block';
        
        // Update stats
        if (data.channels_count !== undefined) {
            document.getElementById('channelsCount').textContent = data.channels_count;
        }
        if (data.keywords_count !== undefined) {
            document.getElementById('keywordsCount').textContent = data.keywords_count;
        }
        if (data.messages_found !== undefined) {
            document.getElementById('messagesCount').textContent = data.messages_found;
        }
        
        // Start uptime counter
        if (data.start_time && !startTime) {
            startTime = new Date(data.start_time);
            if (uptimeInterval) clearInterval(uptimeInterval);
            uptimeInterval = setInterval(updateUptime, 1000);
        }
        
    } else if (status === 'scanning') {
        statusIndicator.className = 'badge bg-warning fs-6';
        statusIndicator.textContent = 'Scanning';
        statusDescription.textContent = 'TeleScout is performing a historical scan of channels.';
        
        scanBtn.style.display = 'none';
        realtimeBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        monitoringStats.style.display = 'block';
        
        // Update stats for scanning too
        if (data.channels_count !== undefined) {
            document.getElementById('channelsCount').textContent = data.channels_count;
        }
        if (data.keywords_count !== undefined) {
            document.getElementById('keywordsCount').textContent = data.keywords_count;
        }
        if (data.messages_found !== undefined) {
            document.getElementById('messagesCount').textContent = data.messages_found;
        }
        
        // Start uptime counter for scanning
        if (data.start_time && !startTime) {
            startTime = new Date(data.start_time);
            if (uptimeInterval) clearInterval(uptimeInterval);
            uptimeInterval = setInterval(updateUptime, 1000);
        }
        
    } else {
        statusIndicator.className = 'badge bg-secondary fs-6';
        statusIndicator.textContent = 'Stopped';
        statusDescription.textContent = 'Click "Scan Only" for historical scan or "Real-Time Monitoring" for live monitoring.';
        
        scanBtn.style.display = 'block';
        realtimeBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        monitoringStats.style.display = 'none';
        
        // Stop uptime counter
        if (uptimeInterval) {
            clearInterval(uptimeInterval);
            uptimeInterval = null;
        }
        startTime = null;
        document.getElementById('uptime').textContent = '00:00:00';
    }
}

function updateUptime() {
    if (!startTime) return;
    
    const now = new Date();
    const diff = Math.floor((now - startTime) / 1000);
    
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    
    const uptime = [hours, minutes, seconds]
        .map(v => v.toString().padStart(2, '0'))
        .join(':');
    
    document.getElementById('uptime').textContent = uptime;
}

async function loadConfigSummary() {
    try {
        const config = await apiRequest('/api/config');
        
        document.getElementById('forwardUserId').textContent = 
            config.forward_to_user_id || 'Not configured';
        
        document.getElementById('timeWindow').textContent = 
            config.time_window_hours ? `${config.time_window_hours} hours` : 'Real-time only';
        
        document.getElementById('forwardDelay').textContent = 
            `${config.forward_delay || 5} seconds`;
            
    } catch (error) {
        console.error('Failed to load config summary:', error);
    }
}
</script>
{% endblock %}